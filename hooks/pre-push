#!/bin/bash

TOML_FILE=".bumpversion.toml"

# Get the current version from the TOML file
current_version=$(grep -Po '(?<=current_version = ")[^"]+' "$TOML_FILE")

# Check if .bumpversion.toml was changed in the latest commit
if ! git diff --name-only HEAD~1 HEAD | grep -q "$TOML_FILE"; then
  echo "You must bump the version in $TOML_FILE before pushing."
  exit 1
fi

# Check if the current_version in the file matches the version added in the latest commit
added_version=$(git diff HEAD~1 HEAD "$TOML_FILE" | grep '^+current_version' | grep -Po '(?<=\")[^\"]+')
if [ -z "$added_version" ]; then
  echo "No version bump detected in $TOML_FILE. Please update the version before pushing."
  exit 1
fi

if [ "$current_version" != "$added_version" ]; then
  echo "Current version in $TOML_FILE ($current_version) does not match the version added in the latest commit ($added_version)."
  exit 1
fi

exit 0